
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/assets/styles/global.css">

    <script src="http://localhost/CO3049_assignment/public/assets/scripts/components.js"></script>

    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/mazor/assets/compiled/css/app.css">



</head>

<body>
    
    <div id="app" class="h-100">
        <div id="header"></div>
        <main class="page-content container-lg h-100" style="margin-top: 150px;">  
            <section class="col">
                <div class="navbar">
                    <h1 >Danh sách rạp</h1>
                <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text" id="basic-addon1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                            </svg>
                        </span>
                        <input type="text" id="cinemaSearch" class="form-control" placeholder="Tìm kiếm theo tên rạp - địa chỉ" aria-label="Search" aria-describedby="basic-addon1">
                    </div>
                </div>
                
                
                <div id="listCinema"></div>
                
                <!-- Pagination -->
                <nav aria-label="Cinema pagination" class="mt-3">
                    <ul id="pagination" class="pagination justify-content-center">
                        <!-- Pagination items will be added here by JavaScript -->
                    </ul>
                </nav>

                <div id="listMovie"></div>


            </section>



            <!-- Footer -->
            <div id="footer"></div>
                
        </main>


    </div>

    

</body>
<script>
    document.getElementById('footer').insertAdjacentHTML("beforeend", renderFooter());
    renderHeader().then(html => {
        document.getElementById('header').insertAdjacentHTML("beforeend", html);
    });

</script>
<script>
    let allCinemas = []; // Dữ liệu rạp gốc
    let currentPage = 1;
    const itemsPerPage = 7; // Số rạp hiển thị trên mỗi trang

    async function getCinema() {
        try {
            const response = await fetch('http://localhost/CO3049_assignment/public/main/getCinema');
            const result = await response.json();
            if (result.status) {
                allCinemas = result.data;
                renderCinemas(allCinemas);
                setupPagination(allCinemas);
            } else {
                console.error('Không có dữ liệu rạp');
            }
        } catch (error) {
            console.error('Lỗi khi lấy dữ liệu rạp:', error);
        }
    }

    function renderCinemas(cinemas) {
        const listCinema = document.getElementById('listCinema');
        if (!listCinema) return;

        // Calculate items to show for current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedItems = cinemas.slice(startIndex, startIndex + itemsPerPage);

        if (paginatedItems.length === 0) {
            listCinema.innerHTML = `<p class="text-muted">Không tìm thấy rạp nào phù hợp.</p>`;
            return;
        }

        listCinema.innerHTML = paginatedItems.map(cinema => `
            <div class="card mb-3 shadow-sm" onclick="getMovieByCinema(${cinema.id})" style="cursor: pointer;">
                <div class="card-body">
                    <h5 class="card-title">${cinema.name}</h5>
                    <p class="card-text">
                        <i class="bi bi-geo-alt-fill text-danger me-1"></i>${cinema.location}<br>
                        <i class="bi bi-clock-fill text-primary me-1"></i>${cinema.open_time} - ${cinema.close_time}
                    </p>
                </div>
            </div>
        `).join('');
    }

    function setupPagination(items) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        const pageCount = Math.ceil(items.length / itemsPerPage);
        
        if (pageCount <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous" onclick="changePage(${currentPage - 1})">
            <span aria-hidden="true">&laquo;</span>
        </a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next" onclick="changePage(${currentPage + 1})">
            <span aria-hidden="true">&raquo;</span>
        </a>`;
        pagination.appendChild(nextLi);
    }

    function changePage(page) {
        if (page < 1 || page > Math.ceil(allCinemas.length / itemsPerPage)) return;
        
        currentPage = page;
        renderCinemas(allCinemas);
        setupPagination(allCinemas);
        
        // Scroll to top of list
        document.getElementById('listCinema').scrollIntoView({ behavior: 'smooth' });
    }

    // Search functionality
    document.getElementById('cinemaSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredCinemas = allCinemas.filter(cinema => 
            cinema.name.toLowerCase().includes(searchTerm) || 
            cinema.location.toLowerCase().includes(searchTerm)
        );
        
        renderCinemas(filteredCinemas);
        setupPagination(filteredCinemas);
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        getCinema();
    });

    async function getMovieByCinema(cinemaId) {
        try {
            document.getElementById("listMovie").scrollIntoView({
                behavior: "smooth" // Cuộn mượt
            });

            const response = await fetch(`http://localhost/CO3049_assignment/public/main/getShowtime?cinema_id=${cinemaId}`);
            const result = await response.json();
            const listMovie = document.getElementById('listMovie');
                listMovie.innerHTML = ''; // Clear previous content
            if (result.status) {   


                const grouped = {};
                for (const showtime of result.data) {
                    if (!grouped[showtime.media_id]) {
                        grouped[showtime.media_id] = [];
                    }
                    grouped[showtime.media_id].push(showtime);
                }

                console.log(grouped);
                for (const [media_id, showtimes] of Object.entries(grouped)) {
                    console.log("Media ID:", media_id);

                    // Nhóm showtimes theo date
                    const groupedByDate = {};
                    for (const s of showtimes) {
                        if (!groupedByDate[s.date]) {
                            groupedByDate[s.date] = [];
                        }
                        groupedByDate[s.date].push(s);
                    }

                    const movieCard = document.createElement('div');
                    movieCard.innerHTML = `
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body row">
                            <div class="col-3">
                                <div class="card-image" style="width: 100%; aspect-ratio: 3 / 5; overflow: hidden; position: relative; border-radius: 12px;">
                                    <img 
                                        src="http://localhost/CO3049_assignment/public/main/displayMedia?id=${media_id}" 
                                        style="width: 100%; height: 100%; object-fit: cover;" 
                                    />
                                </div>                            </div>
                            <div class="col-9">
                                
                                <h5 class="card-title">Phim ID: ${media_id}</h5>

                                ${Object.entries(groupedByDate).map(([date, slots]) => `
                                    <div class="mb-2">
                                        <strong>${date}</strong>
                                        <div>
                                            ${slots.map(slot => `
                                                <a href="http://localhost/CO3049_assignment/public/main/booking?id=${slot.id}" class="badge bg-primary me-2 text-decoration-none text-white p-2 fs-6" >
                                                    ${slot.start_time.slice(11, 16)} - ${slot.end_time.slice(11, 16)}
                                                </a>

                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    `;
                    listMovie.appendChild(movieCard);
                }
            } else {
                alert("Không có dữ liệu phim");
            }
        } catch (error) {
            console.error('Lỗi khi lấy dữ liệu phim:', error);
        }
    }

</script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/compiled/js/app.js"></script>

</html>