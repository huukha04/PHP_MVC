
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/assets/styles/global.css">
    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/assets/styles/seats.css">


    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/mazor/assets/compiled/css/app.css">


    <style>
    
    
    .step-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 2rem;
    gap: 10px;
}

.step-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.step {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #6c757d;
    position: relative;
    z-index: 1;
}

.step-label {
    font-size: 0.85rem;
    margin-top: 6px;
    text-align: center;
    color: #6c757d;
    min-width: 90px;
}

.step.active {
    background-color: #0d6efd;
    color: white;
}

.step.completed {
    background-color: #198754;
    color: white;
}

.step-connector {
    width: 100px;
    height: 2px;
    background-color: #e9ecef;
    margin-top: 17px;
    z-index: 0;
}

.step-connector.active {
    background-color: #0d6efd;
}

    

    </style>
</head>

<body>
    
    <div id="app" class="h-100">
        <div id="header"></div>
        <main class="page-content container-lg h-100" style="margin-top: 150px;">  
            <secsion class="col">
                <div class="step-indicator mb-4">
                    <div class="step-container">
                        <div class="step active">1</div>
                        <div class="step-label">Chọn ghế</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-container">
                        <div class="step">2</div>
                        <div class="step-label">Chọn bắp nước</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step-container">
                        <div class="step">3</div>
                        <div class="step-label">Nhập thông tin</div>
                    </div>
                </div>
                
            </secsion>
            <section class="row">
                <div class="col-9">
                    <div id="seatDisplay">
                        <div class="navbar">
                            <div class="seat standard"></div> <span class="ms-2">Standard</span>
                            <div class="seat vip"></div> <span class="ms-2">VIP</span>
                            <div class="seat couple"></div> <span class="ms-2">Couple</span>
                            <div class="seat maintenance"></div> <span class="ms-2">Maintenance</span>
                        </div>
    
                        <div class="screen">Màn hình</div>
    
                        <div id="seat" class="row p-1">
                                
                        </div>
                        
                    </div>

                    <div id="productDisplay" class="d-none">

                    </div>
                    <div id="infoDisplay" class="d-none">
                        <div class="container py-5">
                            <div class="row justify-content-center">
                                <div class="col-lg-6 col-md-8">

                                    <div class="card shadow">
                                        <div class="card-body p-4">
                                            <div class="step-content" id="step1">
                                                <h5 class="mb-4">Thông tin thanh toán</h5>
                                                <form id="paymentForm">
                                                    <!-- Họ và tên -->
                                                    <div class="mb-4">
                                                        <label class="form-label">Họ và tên</label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">
                                                                <i class="bi bi-person-fill"></i>
                                                            </span>
                                                            <input type="text" class="form-control" name="name" placeholder="Nhập họ và tên của bạn">
                                                        </div>
                                                    </div>
                                    
                                                    <!-- Email -->
                                                    <div class="mb-4">
                                                        <label class="form-label">Địa chỉ email</label>
                                                        <div class="input-group">
                                                            <span class="input-group-text">
                                                                <i class="bi bi-envelope-fill"></i>
                                                            </span>
                                                            <input type="email" name="email" class="form-control" placeholder="Nhập địa chỉ email">
                                                        </div>
                                                        <div class="form-text text-danger">Chúng tôi sẽ gửi thông tin vé qua email của bạn</div>
                                                    </div>
                                
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <div class="col-3">
                    <div class="card shadow rounded-4 border-0">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <span class="text-primary fw-bold">Booking</span> Information
                            </h5>
                        
                            <div class="row mb-2">
                                <div class="col-4 fw-semibold text-muted">Tên phim:</div>
                                <div class="col-8">
                                    <div id="movieName"></div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-semibold text-muted">Tên rạp:</div>
                                <div class="col-8">
                                    <div id="cinemaName"></div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-semibold text-muted">Phòng:</div>
                                <div class="col-8">
                                    <div id="roomName"></div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-semibold text-muted">Suất:</div>
                                <div class="col-8">
                                    <div id="showtime"></div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4 fw-semibold text-muted">Ghế:</div>
                                <div class="col-8">
                                    <div id="seatList"></div>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <div class="col-4 fw-semibold text-muted">Product:</div>
                                <div class="col-8">
                                    <div id="productList"></div>
                                </div>
                            </div>
                        
                            <div class="nav gap-2">
                                <h5 id="countdown" class="fw-bold text-success">5:00</h5>
                                <h5 class="fw-bold text-success">Tổng tiền:
                                    <span id="totalPrice" class="text-danger fw-bold">0</span> VND
                                </h5>
                            </div>
                        </div>
                        
                        <div id="buttonGroup" class="card-footer d-flex justify-content-center gap-3">
                            <button class="btn btn-secondary d-none" id="cancelBooking">Quay lại</button>
                            <button class="btn btn-primary" id="confirmBooking">Tiếp tục</button>
                        </div>
                    </div>
                      
                </div>  

            </section>
            


            <!-- Footer -->
            <div id="footer"></div>
                
        </main>


    </div>

    

</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $('#header').load('http://localhost/CO3049_assignment/public/component/header');
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const cancelBtn = document.getElementById("cancelBooking");
        const confirmBtn = document.getElementById("confirmBooking");

        const seatDisplay = document.getElementById("seatDisplay");
        const productDisplay = document.getElementById("productDisplay");
        const infoDisplay = document.getElementById("infoDisplay");

        const stepElements = document.querySelectorAll(".step-indicator .step");
        let step = 1;

        function updateStep() {
            // Ẩn tất cả các phần
            seatDisplay.classList.add("d-none");
            productDisplay.classList.add("d-none");
            infoDisplay.classList.add("d-none");

            // Cập nhật nội dung theo bước
            if (step === 1) {
                seatDisplay.classList.remove("d-none");
                cancelBtn.classList.add("d-none");
                confirmBtn.textContent = "Tiếp tục";
            } else if (step === 2) {
                productDisplay.classList.remove("d-none");
                cancelBtn.classList.remove("d-none");
                confirmBtn.textContent = "Tiếp tục";
            } else if (step === 3) {
                infoDisplay.classList.remove("d-none");
                cancelBtn.classList.remove("d-none");
                confirmBtn.textContent = "Xác nhận";
            }

            // Cập nhật trạng thái active của step indicator
            stepElements.forEach((el, index) => {
                if (index < step) {
                    el.classList.add("active");
                } else {
                    el.classList.remove("active");
                }
            });
        }

        confirmBtn.addEventListener("click", function () {
            if (step < 3) {
                step++;
                updateStep();
            } else {
                confirmPayment();
            }
        });

        cancelBtn.addEventListener("click", function () {
            if (step > 1) {
                step--;
                updateStep();
            }
        });

        updateStep(); // Gọi khi trang vừa load
    });


    const urlParams = new URLSearchParams(window.location.search);
    const showtimeId = urlParams.get('showtime_id');
    window.onload = function() {
        loadFooter();
        loadSeat();
        loadBookingInfo();

    };

    async function loadFooter() {
        const response = await fetch('http://localhost/CO3049_assignment/public/component/footer');
        const res= await response.text();
        document.getElementById('footer').innerHTML = res;
    }

    async function loadSeat() {
        try {
            const response = await fetch(`http://localhost/CO3049_assignment/public/main/getSeat?showtime_id=${showtimeId}`);
            const data = await response.json();
            if (data.status) {
            const seat = document.getElementById("seat");
            seat.innerHTML = "";
            const seatData = data.data;
            console.log(seatData);



            const rowMap = {};
            seatData.forEach(seat => {
                if (!rowMap[seat.row]) {
                    rowMap[seat.row] = [];
                }
                rowMap[seat.row].push(seat);
            });


            const col1 = document.createElement("div");
            col1.classList.add('col-2', 'd-flex', 'flex-column', 'p-0');
            const col2 = document.createElement("div");
            col2.classList.add('col-10', 'text-start', 'overflow-auto', 'p-0');
            col2.style.whiteSpace = "nowrap";


            Object.entries(rowMap).forEach(([rowIndex, seats]) => {
                const rowSeat2 = document.createElement("div");
                rowSeat2.className = "rowSeat";

                const rowSeat1 = document.createElement("div");
                rowSeat1.className = "rowSeat";

                
                const label = document.createElement("button");
                label.classList.add('seat', 'none');

                label.textContent = String.fromCharCode(64 + parseInt(rowIndex));
                rowSeat1.appendChild(label);
                col1.appendChild(rowSeat1);


                let numSeat = 0;


                seats.forEach(seat => {
                    if (seat.type !== 'none') {
                        numSeat += 1; 
                    }

                    const button = document.createElement("button");
                    button.classList.add("border-0");
                    if (seat.type === 'couple') {
                        button.classList.add("doubleSeat");
                    } else {
                        button.classList.add("seat");
                    }




                    
                    if(seat.status === 'pending') {
                        button.classList.add("pending") 
                    } else if (seat.status === 'completed') {
                        button.classList.add("completed");
                    } else {
                        button.classList.add(seat.type); // thêm theo loại ghế, ví dụ 'couple', 'vip', v.v.
                    }


                    button.onclick = async function() {
                        
                        const isPending = button.classList.contains("pending");
                        startCountdown();

                        const dataForm = new FormData();
                        dataForm.append("showtime_id", showtimeId);
                        dataForm.append("seat_id", seat.id);
                        dataForm.append("order_code", orderCode);

                        if (isPending) {
                            const response = await fetch(`http://localhost/CO3049_assignment/public/main/deleteOrderDetail`, {
                                method: "POST",
                                body: dataForm 
                            });
                            const data = await response.json();
                            if (data.status) {
                                loadSeat();
                                loadBookingInfo();
                            }
                        } else {
                            const response = await fetch(`http://localhost/CO3049_assignment/public/main/insertOrderDetail`, {
                                method: "POST",
                                body: dataForm 
                            });
                            const data = await response.json();
                            if (data.status) {
                                loadSeat();
                                loadBookingInfo();
                            }

                        }

                    
                            
                    };

                    button.innerHTML = seat.code || "&nbsp;";
                    rowSeat2.appendChild(button);
                });
                col2.appendChild(rowSeat2);
                
            });


            seat.appendChild(col1);
            seat.appendChild(col2);

        } 
   
        } catch (error) {
            console.error('Error:', error);
        }
    }


    const orderCode = generateCode(); // Generate the code when the page loads
   function generateCode() {
        const timestamp = Date.now().toString(); // vd: 1713685800123
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const code = (timestamp + random).slice(-8); // Lấy 8 số cuối
        return code;
    }



    let countdownInterval = null;
    let countdownDuration = 5 * 60; // 5 phút

    function startCountdown() {
        // Nếu đang đếm thì dừng lại
        if (countdownInterval !== null) {
            clearInterval(countdownInterval);
        }

        countdownDuration = 5 * 60; // Reset về 5 phút

        const countdownElement = document.getElementById("countdown");
        const confirmBtn = document.getElementById("confirmBooking");

        confirmBtn.disabled = false; // Cho phép lại nếu trước đó đã disable
        confirmBtn.classList.remove("btn-secondary");
        confirmBtn.classList.add("btn-primary");

        countdownInterval = setInterval(() => {
            const minutes = Math.floor(countdownDuration / 60);
            const seconds = countdownDuration % 60;

            countdownElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            if (countdownDuration <= 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;

                confirmBtn.disabled = true;
                confirmBtn.classList.add("btn-secondary");
                confirmBtn.classList.remove("btn-primary");

                countdownElement.textContent = "Hết thời gian";
            }

            countdownDuration--;
        }, 1000);
    }


    async function loadBookingInfo() {
        try {
            const response = await fetch(`http://localhost/CO3049_assignment/public/main/getBookingInfo?showtime_id=${showtimeId}&order_code=${orderCode}`);
            const data = await response.json();
            if (data.status) {
                const bookingInfo = data.data;
                console.log(bookingInfo);
                document.getElementById("movieName").innerHTML = bookingInfo.movie_name;
                document.getElementById("cinemaName").innerHTML = bookingInfo.cinema_name;
                document.getElementById("roomName").innerHTML = bookingInfo.room_name;
                document.getElementById("showtime").innerHTML = bookingInfo.showtime;
                document.getElementById("seatList").innerHTML = bookingInfo.seat_list || "Chưa chọn ghế";
                document.getElementById("productList").innerHTML = bookingInfo.product_list || "Chưa chọn sản phẩm";
                document.getElementById("totalPrice").innerHTML = bookingInfo.total_price || "0";

            }
        } catch (error) {
            console.error('Error:', error);
        }
    }


    async function confirmPayment() {
        try {
            const dataForm = new FormData(document.getElementById("paymentForm"));
            dataForm.append("order_code", orderCode);
            const response = await fetch(`http://localhost/CO3049_assignment/public/main/confirmPayment`, {
                method: "POST",
                body: dataForm 
            });

            const result = await response.json();
            if (result.status) {
                const encodedData = encodeURIComponent(JSON.stringify(result.data));
				window.location.href = `http://localhost/CO3049_assignment/public/main/payment?data=${encodedData}`;
            } else {
                alert("Có lỗi xảy ra, vui lòng thử lại.");
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }



    
</script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/compiled/js/app.js"></script>

</html>