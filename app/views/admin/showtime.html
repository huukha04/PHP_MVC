<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Media</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/mazor/assets/compiled/css/app.css">
    <link rel="stylesheet" href="http://localhost/CO3049_assignment/public/mazor/assets/compiled/css/app-dark.css">


    <script src="http://localhost/CO3049_assignment/public/assets/scripts/components.js"></script>

</head>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/static/js/initTheme.js"></script>

<body>
    
<div id="app">
    <div id="sidebar"></div>

    <div id="main">
        <header class="mb-3 navbar">
            <div class="d-flex gap-5">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
                <h1>Shotime</h1>
            </div>
            <div>
            </div>
            <div class="d-flex gap-1">
                <a href="http://localhost/CO3049_assignment/public/main/home" class="btn btn-primary rounded-pill text-white text-decoration-none fw-bold">Quan sát</a>
                <a href="http://localhost/CO3049_assignment/public/auth/logout" class="btn text-decoration-none fw-bold text-danger">Đăng xuất</a>

            </div>
        </header>

        <div class="page-content"> 
            <section class="row">
                <div class="page-heading">
                    <h3>Thêm mới</h3>
                </div> 
                <div class="page-content">
                    <div class="col">
                        <div class="card shadow">
                            <div class="card-body">
                                <select id="cinemaSelect" class="form-select" aria-label="Chọn rạp">
                                    <option selected>Chọn rạp</option>
                                </select>
                            
                                <!-- Dropdown phòng chiếu -->
                                <select id="roomSelect" class="form-select mt-3" aria-label="Chọn phòng" disabled>
                                    <option selected>Chọn phòng</option>
                                </select>
                                <select id="dateSelect" class="form-select mt-3" aria-label="Chọn ngày" disabled>
                                    <option selected>Chọn ngày</option>
                                </select>
                            </div>                            
                        </div>
                    </div>

                    <div class="col">
                        <div class="card shadow">
                            <div class="card-header">Lập lịch</div>
                                <div class="card-body">    
                                    <div class="row">              
                                        <div class="col-12 col-md-3">                                        
                                            <div id="showtimeForm" class="d-none">
                                                <ul class="timeline">
                                                    <li class="timeline-item">
                                                        <h5 class="fw-bold text-status">Open time </h5>
                                                        <p class="text-muted mb-1 fw-bold" id="open_time">Chưa có thông tin</p>
                                                    </li>
                                                </ul>
                                                <ul class="timeline" id="timeline">
                                                </ul>
                                                <ul class="timeline">
                                                    <li class="timeline-item">
                                                        <button class="btn btn-primary" onclick="inputShowtime()">
                                                            <i class="bi bi-plus-square"></i>
                                                        Thêm mới</button>
                                                    </li>
                                                </ul>
    



                                                <ul class="timeline">
                                                    <li class="timeline-item">
                                                        <h5 class="fw-bold text-danger">Close time </h5>
                                                        <p class="text-muted mb-1 fw-bold" id="close_time">Chưa có thông tin</p>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>  
                                        <!--  -->
                                        <div class="col-12 col-md-9">
                                            <div>Số lượng vé bán ra theo phim</div>
                                            <div>Tỉ lệ lắp đầy suất theo phim</div>
                                            <div></div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                    </div>
                    
                </div>
            </section>
        </div>
    </div>







    <div class="modal fade" id="showtimeModal" tabindex="-1" aria-labelledby="showtimeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="showtimeModalLabel">Chọn Phim và Thời gian</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="movieSelect" class="form-label">Chọn Phim</label>
                        <select class="form-select" id="movieSelect" aria-label="Chọn Phim">
                            <option selected>Chọn phim</option>
                        </select>
                    </div>

                    <!-- Select chọn giờ -->
                    <div class="mb-3">
                        <label for="hourSelect" class="form-label">Chọn giờ</label>
                        <select id="hourSelect" class="form-select">
                        <option value="" disabled selected>Chọn giờ</option>
                        </select>
                    </div>
                    
                    <!-- Select chọn phút -->
                    <div class="mb-3">
                        <label for="minuteSelect" class="form-label">Chọn phút</label>
                        <select id="minuteSelect" class="form-select">
                        <option value="" disabled selected>Chọn phút</option>
                        </select>
                    </div>
                    <div class="text-danger" id="message">Lưu ý: Thời gian bắt đầu phải nằm trong khoảng thời gian mở cửa của rạp</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="insertShowtime()">Lưu</button>
                </div>
            </div>
        </div>
    </div>




</body>
<script>
    document.getElementById("sidebar").insertAdjacentHTML("beforeend", renderSidebar());
    document.body.insertAdjacentHTML("beforeend", renderToggleDark());
</script>
<script>

window.onload = function() {
    loadSelectCinema();
};

document.getElementById("cinemaSelect").addEventListener("change", function() {
    loadSelectRoom();


});
async function loadSelectCinema() {
    try {
        const response = await fetch("http://localhost/CO3049_assignment/public/admin/getCinema");
        const data = await response.json();

        const select = document.getElementById("cinemaSelect");
        select.innerHTML = '<option selected>Chọn rạp</option>'; 
        
        if (data.status) {
            data.data.forEach(cinema => {

                const option = document.createElement("option");
                option.value = cinema.id;
                option.textContent = cinema.name;
                option.setAttribute("data-open", cinema.open_time); 
                option.setAttribute("data-close", cinema.close_time);
                option.setAttribute("id", cinema.id); // Lưu id rạp vào thuộc tính data-id

                select.appendChild(option);
            });
        } else {
            console.error("Dữ liệu rạp không hợp lệ");
        }
    } catch (error) {
        console.error("Lỗi khi lấy danh sách rạp:", error);
    }
}
// ok
document.getElementById("roomSelect").addEventListener("change", function() {
    loadSelectDate(); 
});
async function loadSelectRoom() {
    try {
        const cinemaId = document.getElementById("cinemaSelect").value;
        const roomSelect = document.getElementById("roomSelect");
        roomSelect.innerHTML = '<option selected>Chọn phòng chiếu</option>'; // Reset danh sách
        roomSelect.disabled = true;

        if (!cinemaId) return;
        const response = await fetch(`http://localhost/CO3049_assignment/public/admin/getRoom?cinema_id=${cinemaId}`);
        const data = await response.json();
        console.log(data);

        if (data.status) {
            roomSelect.disabled = false;
            data.data.forEach(room => {
                const option = document.createElement("option");
                option.value = room.id;
                option.textContent = room.name;
                option.setAttribute("id", room.id); // Lưu id phòng vào thuộc tính data-id
                roomSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error("Lỗi khi lấy danh sách phòng chiếu:", error);
    }
}
// ok
document.getElementById("dateSelect").addEventListener("change", function() {
    loadShowtime()
});
function loadSelectDate() {
            function formatDate(date) {
                let day = ("0" + date.getDate()).slice(-2);
                let month = ("0" + (date.getMonth() + 1)).slice(-2);
                let year = date.getFullYear();
                return year + "-" + month + "-" + day;
            }

            const roomId = document.getElementById("roomSelect").value;

            const dateSelect = document.getElementById("dateSelect");
            dateSelect.innerHTML = '<option selected>Chọn ngày</option>'; // Reset danh sách
            dateSelect.disabled = true; 

            if (!roomId) return; // Nếu không có phòng được chọn thì không làm gì cả.

            let today = new Date();
            let minDate = formatDate(today); 

            let maxDate = new Date();
            maxDate.setDate(today.getDate() + 3); 
            maxDate = formatDate(maxDate);       

            dateSelect.disabled = false; // Mở khóa dropdown chọn ngày

            // Xóa các option cũ trong dropdown
            dateSelect.innerHTML = '<option selected>Chọn ngày</option>';

            // Duyệt qua các ngày từ hôm nay đến 7 ngày sau
            for (let i = 0; i <= 6; i++) {
                let currentDate = new Date();
                currentDate.setDate(today.getDate() + i);
                let formattedDate = formatDate(currentDate);

                // Tạo option cho từng ngày
                let option = document.createElement("option");
                option.value = formattedDate;
                option.textContent = formattedDate;
                dateSelect.appendChild(option);
            }
        }

async function loadShowtime() {
    try {
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = '';

        const cinemaSelect = document.getElementById("cinemaSelect");
        const openTime = cinemaSelect.options[cinemaSelect.selectedIndex].getAttribute("data-open");
        const closeTime = cinemaSelect.options[cinemaSelect.selectedIndex].getAttribute("data-close");
        document.getElementById("open_time").textContent = openTime;
        document.getElementById("close_time").textContent = closeTime;


        const roomId = document.getElementById("roomSelect").value;
        const date = document.getElementById("dateSelect").value;
        const showtimeForm = document.getElementById("showtimeForm");
        showtimeForm.classList.remove("d-none");

        if (!date || !roomId) {
            showtimeForm.classList.add("d-none");
            return;
        }

        const response = await fetch(`http://localhost/CO3049_assignment/public/admin/getShowtime?room_id=${roomId}&date=${date}`);
        const data = await response.json();



        if (data.status) {
            timeline.innerHTML = '';

            for (const show of data.data) {
                console.log(show);
                const responseMovie = await fetch(`http://localhost/CO3049_assignment/public/admin/getMedia?id=${show.media_id}&type=movie`);
                const movieData = await responseMovie.json();
                console.log(movieData);
                const movie = movieData.data[0]; // Lấy thông tin phim từ phản hồi
                const li = document.createElement("li");
                li.classList.add("timeline-item", "mb-3", "border", "p-3");

                li.innerHTML = `
                    <h5 class="fw-bold">${movie?.title || show.movie_title}</h5>
                    <div class="text-muted mb-1 fw-bold">${movie?.duration} Phút</div>
                    <div class="text-muted mb-1 fw-bold text-status">Bắt đầu: ${show.start_time}</div>
                    <div class="text-muted mb-1 fw-bold text-danger">Kết thúc: ${show.end_time}</div>

                    <button class="btn btn-danger" onclick="deleteShowtime(${show.id})">Xóa</button>
                `;

                timeline.appendChild(li);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lấy danh sách suất chiếu:", error);
    }
}
// ok

async function insertShowtime() {
    try {
        const showtime = document.getElementById("dateSelect").value;
        const roomId = document.getElementById("roomSelect").value;
        const movieId = document.getElementById("movieSelect").value;
        const hour = document.getElementById("hourSelect").value;
        const minute = document.getElementById("minuteSelect").value;
        const startTimeStr = `${showtime} ${hour}:${minute}:00`;
        let startTime = new Date(startTimeStr);
        
        const cinemaSelect = document.getElementById("cinemaSelect");
        const cinemaId = cinemaSelect.options[cinemaSelect.selectedIndex].getAttribute("id");
        const movieSelect = document.getElementById("movieSelect");
        const duration =  movieSelect.options[ movieSelect.selectedIndex].getAttribute("duration");
        let endTime = new Date(startTime.getTime() + duration * 60000);

        function formatDateTime(date) {
            const pad = n => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ` +
                `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        }

        startTime = formatDateTime(startTime);
        endTime = formatDateTime(endTime);
        console.log("Start Time:", startTime);
        console.log("End Time:", endTime);




        if (!showtime || !roomId || !movieId || !startTime) return;
        const dataForm = new FormData();
        dataForm.append("date", showtime);
        dataForm.append("room_id", roomId);
        dataForm.append("media_id", movieId);
        dataForm.append("start_time", startTime);
        dataForm.append("cinema_id", cinemaId);
        dataForm.append("end_time", endTime);



        const response = await fetch("http://localhost/CO3049_assignment/public/admin/insertShowtime", {
            method: "POST",
            body: dataForm,
        });
        const data = await response.json();
        console.log(data);
        if (data.status) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('showtimeModal'));
            const message = document.getElementById("message");
            message.textContent = "";
            modal.hide();


            loadShowtime();
        } else {
            // Hiển thị thông báo lỗi cho người dùng
            const message = document.getElementById("message");
            message.textContent = data.message.error || "Có lỗi xảy ra. Vui lòng thử lại.";
        }

    } catch (error) {
        console.error("Lỗi khi thêm lịch chiếu:", error);
    }
}

function inputShowtime() {
    try {
        const showtime = document.getElementById("dateSelect").value;
        const roomId = document.getElementById("roomSelect").value;

        if (!showtime || !roomId) return;
            loadMovies();
            const myModal = new bootstrap.Modal(document.getElementById('showtimeModal'), {
            keyboard: false
        });
        loadTimeSelect();
        myModal.show();                
    } catch (error) {
        console.error("Lỗi khi mở modal:", error);
    }
}

async function loadMovies() {
    try {
        const message = document.getElementById("message");
        message.textContent = "";
        const movieSelect = document.getElementById("movieSelect");
        movieSelect.innerHTML = '<option selected>Chọn phim</option>';

        const response = await fetch("http://localhost/CO3049_assignment/public/admin/getMedia?type=movie");
        const data = await response.json();
        console.log(data);
        if (data.status) {
            data.data.forEach(movie => {
                const option = document.createElement("option");
                option.value = movie.id; 
                option.setAttribute("duration", movie.duration); // Lưu thời gian phim vào thuộc tính data-duration
                option.textContent = movie.title; 
                
                movieSelect.appendChild(option);
            });
        }
                
    } catch (error) {
        console.error("Lỗi khi tải danh sách phim:", error);
    }
}
async function loadTimeSelect() {
            try {
                const hourSelect = document.getElementById("hourSelect");
                const minuteSelect = document.getElementById("minuteSelect");
                const cinemaSelect = document.getElementById("cinemaSelect");

                const selectedOption = cinemaSelect.options[cinemaSelect.selectedIndex];
                const openTime = selectedOption.getAttribute("data-open");
                const closeTime = selectedOption.getAttribute("data-close");

                if (!openTime || !closeTime) return;

                const [openHour, openMinute] = openTime.split(':').map(Number);
                const [closeHour, closeMinute] = closeTime.split(':').map(Number);

                // Xóa các option cũ
                hourSelect.innerHTML = '<option value="" disabled selected>Chọn giờ</option>';
                minuteSelect.innerHTML = '<option value="" disabled selected>Chọn phút</option>';

                // Thêm giờ từ open đến close
                for (let h = openHour; h < closeHour; h++) {
                    const hourStr = String(h).padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = hourStr;
                    option.textContent = hourStr;
                    hourSelect.appendChild(option);
                }

                // Thêm phút mỗi 5 phút (00 → 55)
                for (let m = 0; m < 60; m += 5) {
                    const minuteStr = String(m).padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = minuteStr;
                    option.textContent = minuteStr;
                    minuteSelect.appendChild(option);
                }

            } catch (error) {
                console.error("Lỗi khi tải danh sách thời gian:", error);
            }
        }

async function deleteShowtime(id) {
    try {
        if(!confirm("Bạn có chắc chắn muốn xóa suất chiếu này không?")) return;
        const dataForm = new FormData();
        dataForm.append("id", id);
        const response = await fetch(`http://localhost/CO3049_assignment/public/admin/deleteShowtime`, {
            method: "POST",
            body: dataForm,
        });
        const data = await response.json();
        console.log(data);
        if (data.status) {
            loadShowtime();
        } else {
            console.error("Lỗi khi xóa suất chiếu:", data.message);
        }
    } catch (error) {
        console.error("Lỗi khi xóa suất chiếu:", error);
    }
}       


</script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/compiled/js/app.js"></script>
<script src="http://localhost/CO3049_assignment/public/mazor/assets/static/js/components/dark.js"></script>


</html>